#!/usr/bin/env python
# -*- coding: utf-8 -*-

import sys
import os
import logging

log = logging.getLogger()
log.setLevel("INFO")


class Mower:
    """
    Automated mower class

    """

    forward = "A"
    rotate = "DG"
    orientations = {
        "N": {"D": "E", "G": "W"},
        "S": {"D": "W", "G": "E"},
        "E": {"D": "S", "G": "N"},
        "W": {"D": "N", "G": "S"},
    }

    def __init__(self, name, limit, position):
        """
        param name:
        param limit:
        param position:

        """
        self.name = name
        self.limX, self.limY = limit.split(" ")
        self.limX, self.limY = int(self.limX), int(self.limY)
        self.X, self.Y, self.compass = position.split(" ")
        self.X, self.Y, self.compass = int(self.X), int(self.Y), self.compass.strip()
        self.step = {
            "N": (lambda x, y: (x, min(y + 1, self.limY))),
            "S": (lambda x, y: (x, max(y - 1, 0))),
            "E": (lambda x, y: (min(x + 1, self.limX), y)),
            "W": (lambda x, y: (max(x - 1, 0), y)),
        }

    def move(self, instructions):
        """
        param instructions:

        """
        for instr in instructions.strip():
            if instr in self.rotate:
                self.compass = self.orientations[self.compass][instr]
            elif instr == self.forward:
                self.X, self.Y = self.step[self.compass](self.X, self.Y)
            else:
                log.error("Invalid instruction: {}".format(instr))

        return str(self.X) + " " + str(self.Y) + " " + str(self.compass)


def main(argv):
    # Log handler
    handler = logging.StreamHandler()
    handler.setFormatter(
        logging.Formatter("%(asctime)s [%(levelname)s] %(name)s: %(message)s")
    )
    log.addHandler(handler)

    # Expecting one argument
    if len(argv) == 1:
        raise RuntimeError("Input file not specified")
    input_file = argv[1]
    output_file = os.getcwd() + "/MowItNow.out"

    # Expecting an input file
    if not os.path.isfile(input_file):
        raise RuntimeError("Invalid input file or file not found")

    # Initialize output file
    with open(output_file, "w") as outf:
        outf.truncate()

    # Execute input file instructions
    try:
        with open(input_file, "r") as inf:
            index = 0
            fleet = []
            inf.seek(0)
            # Line zero gives perimeter
            limit = inf.readline()
            # The following 2 lines respectively gives position and instructions
            position, instruction = inf.readline(), inf.readline()
            while position:
                log.info(
                    "Instantiating mower #"
                    + str(index + 1)
                    + " - Position is: "
                    + position
                )
                fleet.append(Mower("mower #" + str(index + 1), limit, position))
                log.info(
                    "mower #"
                    + str(index + 1)
                    + " - Executing instruction: "
                    + instruction
                )
                new_position = fleet[index].move(instruction)
                log.info(
                    "mower #" + str(index + 1) + " - New position is: " + new_position
                )
                with open(output_file, "a") as outf:
                    outf.write(new_position + "\n")
                position, instruction = inf.readline(), inf.readline()
                index += 1
    except EnvironmentError as err:
        print("Unexpected environment error: {0}".format(err))

    return output_file


if __name__ == "__main__":
    main(sys.argv)
